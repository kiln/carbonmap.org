#!/bin/bash

set -ex

all_datasets="Continents EmissionsChange CO2perCapita GDPperCapita PopulationGrowth"

(
    echo >&3 "/* This file is auto-generated. Please do not edit. */"
    echo >&3 "/* Generated at $(date) */"
    echo >&3
    
    echo >&4 "// This file is auto-generated. Please do not edit."
    echo >&4 "// Generated at $(date)"
    echo >&4
    echo >&4 "carbonmap_shading = {};"
    
    for f in $all_datasets
    do
        if [ -e carbonmap/data/Shading/With\ alpha-2/"$f".csv ]
        then
            echo >&3 "/* $f */"
            carbonmap/bin/shading-css --class="shading-$f" --shading carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv --data carbonmap/data/Shading/With\ alpha-2/"$f".csv >&3
            carbonmap/bin/shading-css --shading carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv --data carbonmap/data/Shading/With\ alpha-2/"$f".csv > carbonmap/data/Shading/CSS/"$f".css
            
            echo -n >&4 "carbonmap_shading.$f = "
            carbonmap/bin/shading-js "$f" carbonmap/data/Shading/With\ alpha-2/"$f".text.md carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv >&4
            echo >&4 ";"
        fi
    done
) 3> carbonmap/site/shading.css 4> carbonmap/site/data.shading.js

(
    for f in $all_datasets
    do
        echo -n "carbonmap_values.$f = "
        bin/csv-to-json --key Alpha-2 --value "$(bin/csv-header --index=0 carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv)" --type=float --format="{:,.1f}" carbonmap/data/Shading/With\ alpha-2/$f.csv
        echo ';'

        # You can make a (presumably empty) file like Continents.no-rank
        # to indicate that it doesnâ€™t make sense to assign ranks to a dataset.
        if [ ! -e carbonmap/data/Shading/With\ alpha-2/"$f".no-rank ]
        then
            echo -n "carbonmap_rank.$f = "
            bin/csv-to-json --rank --key Alpha-2 --value "$(bin/csv-header --index=0 carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv)" --type=float carbonmap/data/Shading/With\ alpha-2/$f.csv
            echo ';'
        fi
    done
) >> carbonmap/site/data.shading.js

# Generate a spreadsheet showing all the shading data
(
    echo -n "Alpha-2 ISO country code,Country name"
    for f in $all_datasets
    do
        echo -n ",$f"
        if head -1 "carbonmap/data/Shading/With alpha-2/$f.csv" | egrep -q ',Notes(,|$)'
        then
            echo -n ",($f notes)"
            eval has_notes_$f=true
        else
            eval has_notes_$f=false
        fi
    done
    echo
    
    echo -n ","
    for f in $all_datasets
    do
        col="$(bin/csv-header --index=0 carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv)"
        echo -n ",\"$col\""
        eval \${has_notes_$f} && echo ,
    done
    echo

    echo -n ,
    for f in $all_datasets
    do
        echo -n ',"'
        perl -pe 's/"/""/g' "carbonmap/data/Shading/With alpha-2/$f.text.md"
        echo -n '"'
        eval \${has_notes_$f} && echo -n ,
    done
    echo

    # Generate a YAML configuration, and feed it to csv-join
    (
        echo "key: Alpha-2"
        echo "files:"
        echo "- file: data/continents.csv"
        echo "  key: iso2"
        echo "  values: [name]"
        for f in $all_datasets
        do
            col="$(bin/csv-header --index=0 carbonmap/data/Shading/With\ alpha-2/"$f".shading.csv)"
            eval has_notes=\${has_notes_$f}
            
            echo "- file: carbonmap/data/Shading/With alpha-2/$f.csv"
            echo "  values:"
            echo "  - $col"
            if $has_notes
            then
                echo "  - Notes"
            fi
        done
    ) | bin/csv-join
) > carbonmap/site/shading-data.csv
